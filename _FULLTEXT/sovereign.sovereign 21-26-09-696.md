introduction sovereign is a set of ansible playbooks that you can use to build and maintain your own personal cloud based entirely on open source software so youre in control if youve never used ansible before you might find these playbooks useful to learn from since they show off a fair bit of what the tool can do the original authors background and motivations might be of interest tl dr frustrations with google apps and concerns about privacy and long term support sovereign offers useful cloud services while being reasonably secure and low maintenance use it to set up your server ssh in every couple weeks but mostly forget about it services provided what do you get if you point sovereign at a server all kinds of good stuff imap over ssl via dovecot complete with full text search provided by solr pop3 over ssl also via dovecot smtp over ssl via postfix including a nice set of dnsbls to discard spam before it ever hits your filters virtual domains for your email backed by postgresql spam fighting via rspamd mail server verification using dkim and dmarc so the internet knows your mailserver is legit secure on disk storage for email and more via encfs webmail via roundcube mobile push notifications via z push email client automatic configuration jabber xmpp instant messaging via prosody an rss reader via selfoss caldav and carddav to keep your calendars and contacts in sync via owncloud your own private storage cloud via owncloud your own vpn server via openvpn an irc bouncer via znc monit to keep everything running smoothly and alert you when its not collectd to collect system statistics web hosting ex for your blog via apache firewall management via uncomplicated firewall ufw intrusion prevention via fail2ban and rootkit detection via rkhunter ssh configuration preventing root login and insecure password authentication rfc6238 two factor authentication compatible with google authenticator and various hardware tokens nightly backups to tarsnap git hosting via cgit and gitolite read it later via wallabag a bunch of nice to have tools like mosh and htop that make life with a server a little easier dont want one or more of the above services comment out the relevant role in site yml or get more granular and comment out the associated include directive in one of the playbooks usage what youll need a vps or bare metal server if you wanna ball hard my vps is hosted at linode youll probably want at least 512 mb of ram between apache solr and postgresql mine has 1024 64 bit debian 8 3 or an equivalent linux distribution you can use whatever distro you want but deviating from debian will require more tweaks to the playbooks see ansibles different packaging modules a tarsnap account with some credit in it you could comment this out if you want to use a different backup service consider paying your hosting provider for backups or using an additional backup service for redundancy you do not need to acquire an ssl certificate the ssl certificates you need will be obtained from lets encrypt automatically when you deploy your server installation on the remote server the following steps are done on the remote server by sshing into it and running these commands 1 install required packages e g aptitude is required on debian apt get install sudo python 2 get a tarsnap machine key if you havent already download and install tarsnap or use brew install tarsnap if you use homebrew create a new machine key for your server tarsnap keygen keyfile roles tarsnap files decrypted tarsnap key user me example com machine example com 3 prep the server for goodness sake change the root password passwd create a user account for ansible to do its thing through useradd deploy passwd deploy mkdir home deploy authorize your ssh key if you want passwordless ssh login optional mkdir home deploy ssh chmod 700 home deploy ssh nano home deploy ssh authorized keys chmod 400 home deploy ssh authorized keys chown deploy deploy home deploy r echo deploy all all nopasswd all etc sudoers d deploy your new account will be automatically set up for passwordless sudo or you can just add your deploy user to the sudo group adduser deploy sudo on your local machine ansible the tool setting up your server runs locally on your computer and sends commands to the remote server download this repository somewhere on your machine either through clone or download download zip above wget or git as below git clone https github com sovereign sovereign git 4 configure your installation modify the settings in the group vars sovereign folder to your liking if you want to see how theyre used in context just search for the corresponding string all of the variables in group vars sovereign must be set for sovereign to function for git hosting copy your public key into place cp ssh id rsa pub roles git files gitolite pub finally replace the host example net in the file hosts if your ssh daemon listens on a non standard port add a colon and the port number after the ip address in that case you also need to add your custom port to the task set firewall rules for web traffic and ssh in the file roles common tasks ufw yml 5 set up dns if youve just bought a new domain name point it at linodes dns manager or similar most vps services and even some domain registrars offer a managed dns service that you can use for this at no charge if youre using an existing domain thats already managed elsewhere you can probably just modify a few records create a or cname records which point to your servers ip address example com mail example com www example com for web hosting autoconfig example com for email client automatic configuration read example com for wallabag news example com for selfoss cloud example com for owncloud git example com for cgit 6 run the ansible playbooks first make sure youve got ansible 1 9 3 installed to run the whole dang thing ansible playbook i hosts ask sudo pass site yml if you chose to make a passwordless sudo deploy user you can omit the ask sudo pass argument to run just one or more piece use tags i try to tag all my includes for easy isolated development for example to focus in on your firewall setup ansible playbook i hosts tags ufw site yml you might find that it fails at one point or another this is probably because something needs to be done manually usually because theres no good way of automating it fortunately all the tasks are clearly named so you should be able to find out where it stopped ive tried to add comments where manual intervention is necessary the dependencies tag just installs dependencies performing no other operations the tasks associated with the dependencies tag do not rely on the user provided settings that live in group vars sovereign running the playbook with the dependencies tag is particularly convenient for working with docker images 7 finish dns set up create an mx record for example com which assigns mail example com as the domains mail server to ensure your emails pass dkim checks you need to add a txt record the name field will be default domainkey example com the value field contains the public key used by dkim the exact value needed can be found in the file var lib rspamd dkim example com default txt it will look something like this v dkim1 k rsa p migfma0gcsqgsib3dqebaquaa4gnadcbiqkbgqdkkaqfmwkvx ojripqi ag4utwynsxkjgbgtl7tk6umtuwhmqnitqbr zqezjcnoltkndtykzy2z6lqvm4ksritpimbkv1ex6gkczt8lws5kxn 6bhckulgdiretaur3id7mtjlrbi e3248pq0zs39hkdxsdcve12wccjafjvwidaqab for dmarc youll also need to add a txt record the name field should be dmarc example com and the value should be v dmarc1 p none more info on dmarc can be found here set up spf and reverse dns as per this post make sure to validate that its all working for example by sending an email to check auth verifier port25 com and reviewing the report that will be emailed back to you 8 miscellaneous configuration sign in to the znc web interface and set things up to your liking it isnt exposed through the firewall so you must first set up an ssh tunnel ssh deploy example com l 6643 localhost 6643 then proceed to http localhost 6643 in your web browser similarly to access the server monitoring page use another ssh tunnel ssh deploy example com l 2812 localhost 2812 again proceeding to http localhost 2812 in your web browser finally sign into owncloud with a new administrator account to set it up you should select postgresql as the configuration backend use owncloud as the database user and the database name for the database password ansible has created a set of random passwords for each service and stores them in your local folder secret use the one in the file owncloud db password how to use your new personal cloud were collecting known good client setups on our wiki troubleshooting if you run into an errors please check the wiki page if the problem you encountered is not listed please go ahead and create an issue if you already have a bugfix and or workaround just put them in the issue and the wiki page reboots you will need to manually enter the password for any encrypted volumes on reboot this is not sovereign specific but rather a function of how encfs works this will necessitate sshing into your machine after reboot or accessing it via a console interface if one is available to you once youre in run this encfs encrypted decrypted public it is possible that some daemons may need to be restarted after you enter your password for the encrypted volume s some services may stall out while looking for resources that will only be available once the decrypted volume is available and visible to daemon user accounts irc ask questions and provide feedback in sovereign on freenode