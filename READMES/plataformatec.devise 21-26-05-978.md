by plataformatec this readme is also available in a friendly navigable format devise is a flexible authentication solution for rails based on warden it is rack based is a complete mvc solution based on rails engines allows you to have multiple models signed in at the same time is based on a modularity concept use only what you really need its composed of 10 modules database authenticatable hashes and stores a password in the database to validate the authenticity of a user while signing in the authentication can be done both through post requests or http basic authentication omniauthable adds omniauth https github com omniauth omniauth support confirmable sends emails with confirmation instructions and verifies whether an account is already confirmed during sign in recoverable resets the user password and sends reset instructions registerable handles signing up users through a registration process also allowing them to edit and destroy their account rememberable manages generating and clearing a token for remembering the user from a saved cookie trackable tracks sign in count timestamps and ip address timeoutable expires sessions that have not been active in a specified period of time validatable provides validations of email and password its optional and can be customized so youre able to define your own validations lockable locks an account after a specified number of failed sign in attempts can unlock via email or after a specified time period table of contents toc depthfrom 1 depthto 6 withlinks 1 orderedlist 0 information the devise wiki bug reports stackoverflow and mailing list rdocs example applications extensions contributing starting with rails getting started controller filters and helpers configuring models strong parameters configuring views configuring controllers configuring routes i18n test helpers controller tests integration tests omniauth configuring multiple models activejob integration password reset tokens and rails logs other orms additional information heroku warden contributors license toc information the devise wiki the devise wiki has lots of additional information about devise including many how to articles and answers to the most frequently asked questions please browse the wiki after finishing this readme https github com plataformatec devise wiki bug reports if you discover a problem with devise we would like to know about it however we ask that you please review these guidelines before submitting a bug report https github com plataformatec devise wiki bug reports if you have discovered a security related bug please do not use the github issue tracker send an email to opensource plataformatec com br stackoverflow and mailing list if you have any questions comments or concerns please use stackoverflow instead of the github issue tracker http stackoverflow com questions tagged devise the deprecated mailing list can still be read on https groups google com group plataformatec devise rdocs you can view the devise documentation in rdoc format here http rubydoc info github plataformatec devise master frames if you need to use devise with previous versions of rails you can always run gem server from the command line after you install the gem to access the old documentation example applications there are a few example applications available on github that demonstrate various features of devise with different versions of rails you can view them here https github com plataformatec devise wiki example applications extensions our community has created a number of extensions that add functionality above and beyond what is included with devise you can view a list of available extensions and add your own here https github com plataformatec devise wiki extensions contributing we hope that you will consider contributing to devise please read this short overview for some information about how to get started https github com plataformatec devise wiki contributing you will usually want to write tests for your changes to run the test suite go into devises top level directory and run bundle install and bin test devise works with multiple ruby and rails versions and activerecord and mongoid orms which means you can run the test suite with some modifiers devise orm and bundle gemfile devise orm since devise support both mongoid and activerecord we rely on this variable to run specific code for each orm the default value of devise orm is active record to run the tests for mongoid you can pass mongoid devise orm mongoid bin test devise orm mongoid when running the tests for mongoid you will need to have a mongodb server version 2 0 or newer running on your system please note that the command output will show the variable value being used bundle gemfile we can use this variable to tell bundler what gemfile it should use instead of the one in the current directory inside the gemfiles directory we have one for each version of rails we support when you send us a pull request it may happen that the test suite breaks on travis using some of them if thats the case you can simulate the same environment using the bundle gemfile variable for example if the tests broke using ruby 2 4 2 and rails 4 1 you can do the following bash rbenv shell 2 4 2 or rvm use 2 4 2 bundle gemfile gemfiles gemfile rails 4 1 stable bundle install bundle gemfile gemfiles gemfile rails 4 1 stable bin test you can also combine both of them if the tests broke for mongoid bash bundle gemfile gemfiles gemfile rails 4 1 stable bundle install bundle gemfile gemfiles gemfile rails 4 1 stable devise orm mongoid bin test starting with rails if you are building your first rails application we recommend you do not use devise devise requires a good understanding of the rails framework in such cases we advise you to start a simple authentication system from scratch today we have three resources that should help you get started michael hartls online book https www railstutorial org book modeling users ryan bates railscast http railscasts com episodes 250 authentication from scratch codecademys ruby on rails authentication and authorization http www codecademy com en learn rails auth once you have solidified your understanding of rails and authentication mechanisms we assure you devise will be very pleasant to work with smiley getting started devise 4 0 works with rails 4 1 onwards add the following line to your gemfile ruby gem devise then run bundle install next you need to run the generator console rails generate devise install at this point a number of instructions will appear in the console among these instructions youll need to set up the default url options for the devise mailer in each environment here is a possible configuration for config environments development rb ruby config action mailer default url options host localhost port 3000 the generator will install an initializer which describes all of devises configuration options it is imperative that you take a look at it when you are done you are ready to add devise to any of your models using the generator in the following command you will replace model with the class name used for the applications users its frequently user but could also be admin this will create a model if one does not exist and configure it with the default devise modules the generator also configures your config routes rb file to point to the devise controller console rails generate devise model next check the model for any additional configuration options you might want to add such as confirmable or lockable if you add an option be sure to inspect the migration file created by the generator if your orm supports them and uncomment the appropriate section for example if you add the confirmable option in the model youll need to uncomment the confirmable section in the migration then run rails db migrate you should restart your application after changing devises configuration options this includes stopping spring otherwise you will run into strange errors for example users being unable to login and route helpers being undefined controller filters and helpers devise will create some helpers to use inside your controllers and views to set up a controller with user authentication just add this before action assuming your devise model is user ruby before action authenticate user for rails 5 note that protect from forgery is no longer prepended to the before action chain so if you have set authenticate user before protect from forgery your request will result in cant verify csrf token authenticity to resolve this either change the order in which you call them or use protect from forgery prepend true if your devise model is something other than user replace user with yourmodel the same logic applies to the instructions below to verify if a user is signed in use the following helper ruby user signed in for the current signed in user this helper is available ruby current user you can access the session for this scope ruby user session after signing in a user confirming the account or updating the password devise will look for a scoped root path to redirect to for instance when using a user resource the user root path will be used if it exists otherwise the default root path will be used this means that you need to set the root inside your routes ruby root to home index you can also override after sign in path for and after sign out path for to customize your redirect hooks notice that if your devise model is called member instead of user for example then the helpers available are ruby before action authenticate member member signed in current member member session configuring models the devise method in your models also accepts some options to configure its modules for example you can choose the cost of the hashing algorithm with ruby devise database authenticatable registerable confirmable recoverable stretches 12 besides stretches you can define pepper encryptor confirm within remember for timeout in unlock in among other options for more details see the initializer file that was created when you invoked the devise install generator described above this file is usually located at config initializers devise rb strong parameters for previous devise versions see https github com plataformatec devise tree 3 stable strong parameters when you customize your own views you may end up adding new attributes to forms rails 4 moved the parameter sanitization from the model to the controller causing devise to handle this concern at the controller as well there are just three actions in devise that allow any set of parameters to be passed down to the model therefore requiring sanitization their names and default permitted parameters are sign in devise sessionscontroller create permits only the authentication keys like email sign up devise registrationscontroller create permits authentication keys plus password and password confirmation account update devise registrationscontroller update permits authentication keys plus password password confirmation and current password in case you want to permit additional parameters the lazy way™ you can do so using a simple before filter in your applicationcontroller ruby class applicationcontroller actioncontroller base before action configure permitted parameters if devise controller protected def configure permitted parameters devise parameter sanitizer permit sign up keys username end end the above works for any additional fields where the parameters are simple scalar types if you have nested attributes say youre using accepts nested attributes for then you will need to tell devise about those nestings and types ruby class applicationcontroller actioncontroller base before action configure permitted parameters if devise controller protected def configure permitted parameters devise parameter sanitizer permit sign up keys first name last name address attributes country state city area postal code end end devise allows you to completely change devise defaults or invoke custom behaviour by passing a block to permit simple scalar values for username and email use this ruby def configure permitted parameters devise parameter sanitizer permit sign in do user params user params permit username email end end if you have some checkboxes that express the roles a user may take on registration the browser will send those selected checkboxes as an array an array is not one of strong parameters permitted scalars so we need to configure devise in the following way ruby def configure permitted parameters devise parameter sanitizer permit sign up do user params user params permit roles email password password confirmation end end for the list of permitted scalars and how to declare permitted keys in nested hashes and arrays see https github com rails strong parameters nested parameters if you have multiple devise models you may want to set up a different parameter sanitizer per model in this case we recommend inheriting from devise parametersanitizer and adding your own logic ruby class user parametersanitizer devise parametersanitizer def initialize super permit sign up keys username email end end and then configure your controllers to use it ruby class applicationcontroller actioncontroller base protected def devise parameter sanitizer if resource class user user parametersanitizer new user user params else super use the default one end end end the example above overrides the permitted parameters for the user to be both username and email the non lazy way to configure parameters would be by defining the before filter above in a custom controller we detail how to configure and customize controllers in some sections below configuring views we built devise to help you quickly develop an application that uses authentication however we dont want to be in your way when you need to customize it since devise is an engine all its views are packaged inside the gem these views will help you get started but after some time you may want to change them if this is the case you just need to invoke the following generator and it will copy all views to your application console rails generate devise views if you have more than one devise model in your application such as user and admin you will notice that devise uses the same views for all models fortunately devise offers an easy way to customize views all you need to do is set config scoped views true inside the config initializers devise rb file after doing so you will be able to have views based on the role like users sessions new and admins sessions new if no view is found within the scope devise will use the default view at devise sessions new you can also use the generator to generate scoped views console rails generate devise views users if you would like to generate only a few sets of views like the ones for the registerable and confirmable module you can pass a list of modules to the generator with the v flag console rails generate devise views v registrations confirmations configuring controllers if the customization at the views level is not enough you can customize each controller by following these steps create your custom controllers using the generator which requires a scope console rails generate devise controllers scope if you specify users as the scope controllers will be created in app controllers users and the sessions controller will look like this ruby class users sessionscontroller devise sessionscontroller get resource sign in def new super end end use the c flag to specify a controller for example rails generate devise controllers users c sessions tell the router to use this controller ruby devise for users controllers sessions users sessions copy the views from devise sessions to users sessions since the controller was changed it wont use the default views located in devise sessions finally change or extend the desired controller actions you can completely override a controller action ruby class users sessionscontroller devise sessionscontroller def create custom sign in code end end or you can simply add new behaviour to it ruby class users sessionscontroller devise sessionscontroller def create super do resource backgroundworker trigger resource end end end this is useful for triggering background jobs or logging events during certain actions remember that devise uses flash messages to let users know if sign in was successful or unsuccessful devise expects your application to call flash notice and flash alert as appropriate do not print the entire flash hash print only specific keys in some circumstances devise adds a timedout key to the flash hash which is not meant for display remove this key from the hash if you intend to print the entire hash configuring routes devise also ships with default routes if you need to customize them you should probably be able to do it through the devise for method it accepts several options like class name path prefix and so on including the possibility to change path names for i18n ruby devise for users path auth path names sign in login sign out logout password secret confirmation verification unlock unblock registration register sign up cmon let me in be sure to check devise for documentation for details if you have the need for more deep customization for instance to also allow sign in besides users sign in all you need to do is create your routes normally and wrap them in a devise scope block in the router ruby devise scope user do get sign in to devise sessions new end this way you tell devise to use the scope user when sign in is accessed notice devise scope is also aliased as as in your router please note you will still need to add devise for in your routes in order to use helper methods such as current user ruby devise for users skip all i18n devise uses flash messages with i18n in conjunction with the flash keys notice and alert to customize your app you can set up your locale file yaml en devise sessions signed in signed in successfully you can also create distinct messages based on the resource youve configured using the singular name given in routes yaml en devise sessions user signed in welcome user you are signed in admin signed in hello admin the devise mailer uses a similar pattern to create subject messages yaml en devise mailer confirmation instructions subject hello everybody user subject hello user please confirm your email reset password instructions subject reset instructions take a look at our locale file to check all available messages you may also be interested in one of the many translations that are available on our wiki https github com plataformatec devise wiki i18n caution devise controllers inherit from applicationcontroller if your app uses multiple locales you should be sure to set i18n locale in applicationcontroller test helpers devise includes some test helpers for controller and integration tests in order to use them you need to include the respective module in your test cases specs controller tests controller tests require that you include devise test controllerhelpers on your test case or its parent actioncontroller testcase superclass for rails 5 include devise test integrationhelpers instead since the superclass for controller tests has been changed to actiondispatch integrationtest for more details see the integration tests section ruby class postscontrollertest actioncontroller testcase include devise test controllerhelpers end if youre using rspec you can put the following inside a file named spec support devise rb or in your spec spec helper rb or spec rails helper rb if you are using rspec rails ruby rspec configure do config config include devise test controllerhelpers type controller config include devise test controllerhelpers type view end just be sure that this inclusion is made after the require rspec rails directive now you are ready to use the sign in and sign out methods on your controller tests ruby sign in user sign in user scope admin if you are testing devise internal controllers or a controller that inherits from devises you need to tell devise which mapping should be used before a request this is necessary because devise gets this information from the router but since controller tests do not pass through the router it needs to be stated explicitly for example if you are testing the user scope simply use ruby test get new do mimic the router behavior of setting the devise scope through the env request env devise mapping devise mappings user use the sign in helper to sign in a fixture user record sign in users alice get new assert something end integration tests integration test helpers are available by including the devise test integrationhelpers module ruby class poststests actiondispatch integrationtest include devise test integrationhelpers end now you can use the following sign in and sign out methods in your integration tests ruby sign in users bob sign in users bob scope admin sign out user rspec users can include the integrationhelpers module on their feature specs ruby rspec configure do config config include devise test integrationhelpers type feature end unlike controller tests integration tests do not need to supply the devise mapping env value as the mapping can be inferred by the routes that are executed in your tests you can read more about testing your rails 3 rails 4 controllers with rspec in the wiki https github com plataformatec devise wiki how to test controllers with rails 3 and 4 28and rspec 29 omniauth devise comes with omniauth support out of the box to authenticate with other providers to use it simply specify your omniauth configuration in config initializers devise rb ruby config omniauth github app id app secret scope user public repo you can read more about omniauth support in the wiki https github com plataformatec devise wiki omniauth overview configuring multiple models devise allows you to set up as many devise models as you want if you want to have an admin model with just authentication and timeout features in addition to the user model above just run ruby create a migration with the required fields create table admins do t t string email t string encrypted password t timestamps null false end inside your admin model devise database authenticatable timeoutable inside your routes devise for admins inside your protected controller before action authenticate admin inside your controllers and views admin signed in current admin admin session alternatively you can simply run the devise generator keep in mind that those models will have completely different routes they do not and cannot share the same controller for sign in sign out and so on in case you want to have different roles sharing the same actions we recommend that you use a role based approach by either providing a role column or using a dedicated gem for authorization activejob integration if you are using rails 4 2 and activejob to deliver actionmailer messages in the background through a queuing back end you can send devise emails through your existing queue by overriding the send devise notification method in your model ruby def send devise notification notification args devise mailer send notification self args deliver later end password reset tokens and rails logs if you enable the recoverable module note that a stolen password reset token could give an attacker access to your application devise takes effort to generate random secure tokens and stores only token digests in the database never plaintext however the default logging behavior in rails can cause plaintext tokens to leak into log files action mailer logs the entire contents of all outgoing emails to the debug level password reset tokens delivered to users in email will be leaked active job logs all arguments to every enqueued job at the info level if you configure devise to use deliver later to send password reset emails password reset tokens will be leaked rails sets the production logger level to debug by default consider changing your production logger level to warn if you wish to prevent tokens from being leaked into your logs in config environments production rb ruby config log level warn other orms devise supports activerecord default and mongoid to select another orm simply require it in the initializer file additional information heroku using devise on heroku with ruby on rails 3 2 requires setting ruby config assets initialize on precompile false read more about the potential issues at http guides rubyonrails org asset pipeline html warden devise is based on warden which is a general rack authentication framework created by daniel neighman we encourage you to read more about warden here https github com hassox warden contributors we have a long list of valued contributors check them all at https github com plataformatec devise graphs contributors license mit license copyright 2009 2018 plataformatec http plataformatec com br you are not granted rights or licenses to the trademarks of plataformatec including without limitation the devise name or logo