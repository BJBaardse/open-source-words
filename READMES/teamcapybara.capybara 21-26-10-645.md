capybara note you are viewing the readme for the development version of capybara if you are using the current release version you can find the readme at https github com teamcapybara capybara blob 3 3 stable readme md capybara helps you test web applications by simulating how a real user would interact with your app it is agnostic about the driver running your tests and comes with rack test and selenium support built in webkit is supported through an external gem support capybara if you and or your company find value in capybara and would like to contribute financially to its ongoing maintenance and development please visit patreon need help ask on the mailing list please do not open an issue on github http groups google com group ruby capybara table of contents key benefits setup using capybara with cucumber using capybara with rspec using capybara with test unit using capybara with minitest using capybara with minitest spec drivers selecting the driver racktest selenium capybara webkit poltergeist the dsl navigating clicking links and buttons interacting with forms querying finding scoping working with windows scripting modals debugging matching exactness strategy transactions and database setup asynchronous javascript ajax and friends using the dsl elsewhere calling remote servers using sessions xpath css and selectors beware the xpath trap configuring and adding drivers gotchas threadsafe mode development key benefits no setup necessary for rails and rack application works out of the box intuitive api which mimics the language an actual user would use switch the backend your tests run against from fast headless mode to an actual browser with no changes to your tests powerful synchronization features mean you never have to manually wait for asynchronous processes to complete setup capybara requires ruby 2 2 2 or later to install add this line to your gemfile and run bundle install ruby gem capybara if the application that you are testing is a rails app add this line to your test helper file ruby require capybara rails if the application that you are testing is a rack app but not rails set capybara app to your rack app ruby capybara app myrackapp if you need to test javascript or if your app interacts with or is located at a remote url youll need to use a different driver if using rails 5 0 but not using the rails system tests from 5 1 youll probably also want to swap the server used to launch your app to puma in order to match rails defaults ruby capybara server puma until your setup is working capybara server puma silent true to clean up your test output using capybara with cucumber the cucumber rails gem comes with capybara support built in if you are not using rails manually load the capybara cucumber module ruby require capybara cucumber capybara app myrackapp you can use the capybara dsl in your steps like so ruby when i sign in do within session do fill in email with user example com fill in password with password end click button sign in end you can switch to the capybara javascript driver selenium by default by tagging scenarios or features with javascript ruby javascript scenario do something ajaxy when i click the ajax link there are also explicit tags for each registered driver set up for you selenium rack test etc using capybara with rspec load rspec 3 x support by adding the following line typically to your spec helper rb file ruby require capybara rspec if you are using rails put your capybara specs in spec features or spec system only works if you have it configured in rspec and if you have your capybara specs in a different directory then tag the example groups with type feature or type system depending on which type of test youre writing if you are not using rails tag all the example groups in which you want to use capybara with type feature you can now write your specs like so ruby describe the signin process type feature do before each do user make email user example com password password end it signs me in do visit sessions new within session do fill in email with user example com fill in password with password end click button sign in expect page to have content success end end use js true to switch to the capybara javascript driver selenium by default or provide a driver option to switch to one specific driver for example ruby describe some stuff which requires js js true do it will use the default js driver it will switch to one specific driver driver webkit end capybara also comes with a built in dsl for creating descriptive acceptance tests ruby feature signing in do background do user make email user example com password caplin end scenario signing in with correct credentials do visit sessions new within session do fill in email with user example com fill in password with caplin end click button sign in expect page to have content success end given other user user make email other example com password rous scenario signing in as another user do visit sessions new within session do fill in email with other user email fill in password with other user password end click button sign in expect page to have content invalid email or password end end feature is in fact just an alias for describe type feature background is an alias for before scenario for it and given given aliases for let let respectively finally capybara matchers are also supported in view specs ruby rspec describe todos show html erb type view do it displays the todo title do assign todo todo new title buy milk render expect rendered to have css header h1 text buy milk end end note when you require capybara rspec proxy methods are installed to work around name collisions between capybara dsl methods all within and the identically named built in rspec matchers if you opt not to require capybara rspec you can install the proxy methods by requiring capybara rspec matcher proxies after requiring rspec and capybara dsl using capybara with test unit if you are using test unit define a base class for your capybara tests like so ruby require capybara dsl class capybaratestcase test unit testcase include capybara dsl def teardown capybara reset sessions capybara use default driver end end using capybara with minitest if you are using rails add the following code in your test helper rb file to make capybara available in all test cases deriving from actiondispatch integrationtest ruby require capybara rails require capybara minitest class actiondispatch integrationtest make the capybara dsl available in all integration tests include capybara dsl make assert methods behave like minitest assertions include capybara minitest assertions reset sessions and driver between tests use super wherever this method is redefined in your individual test classes def teardown capybara reset sessions capybara use default driver end end if you are not using rails define a base class for your capybara tests like so ruby require capybara minitest class capybaratestcase minitest test include capybara dsl include capybara minitest assertions def teardown capybara reset sessions capybara use default driver end end remember to call super in any subclasses that override teardown to switch the driver set capybara current driver for instance ruby class blogtest actiondispatch integrationtest setup do capybara current driver capybara javascript driver selenium by default end test shows blog posts do this test is run with selenium end end using capybara with minitest spec follow the above instructions for minitest and additionally require capybara minitest spec ruby page must have content important drivers capybara uses the same dsl to drive a variety of browser and headless drivers selecting the driver by default capybara uses the rack test driver which is fast but limited it does not support javascript nor is it able to access http resources outside of your rack application such as remote apis and oauth services to get around these limitations you can set up a different default driver for your features for example if youd prefer to run everything in selenium you could do ruby capybara default driver selenium selenium chrome and selenium chrome headless are also registered however if you are using rspec or cucumber you may instead want to consider leaving the faster rack test as the default driver and marking only those tests that require a javascript capable driver using js true or javascript respectively by default javascript tests are run using the selenium driver you can change this by setting capybara javascript driver you can also change the driver temporarily typically in the before setup and after teardown blocks ruby capybara current driver webkit temporarily select different driver tests here capybara use default driver switch back to default driver note switching the driver creates a new session so you may not be able to switch in the middle of a test racktest racktest is capybaras default driver it is written in pure ruby and does not have any support for executing javascript since the racktest driver interacts directly with rack interfaces it does not require a server to be started however this means that if your application is not a rack application rails sinatra and most other ruby frameworks are rack applications then you cannot use this driver furthermore you cannot use the racktest driver to test a remote application or to access remote urls e g redirects to external sites external apis or oauth services that your application might interact with capybara mechanize provides a similar driver that can access remote servers racktest can be configured with a set of headers like this ruby capybara register driver rack test do app capybara racktest driver new app headers http user agent capybara end see the section on adding and configuring drivers selenium at the moment capybara supports selenium 2 0 webdriver not selenium rc in order to use selenium youll need to install the selenium webdriver gem and add it to your gemfile if youre using bundler provided firefox is installed everything is set up for you and you should be able to start using selenium right away note drivers which run the server in a different thread may not share the same transaction as your tests causing data not to be shared between your test and test server see transactions and database setup below capybara webkit the capybara webkit driver is for true headless testing it uses qtwebkit to start a rendering engine process it can execute javascript as well it is significantly faster than drivers like selenium since it does not load an entire browser you can install it with bash gem install capybara webkit and you can use it by ruby capybara javascript driver webkit poltergeist poltergeist is another headless driver which integrates capybara with phantomjs it is truly headless so doesnt require xvfb to run on your ci server it will also detect and report any javascript errors that happen within the page the dsl a complete reference is available at rubydoc info note by default capybara will only locate visible elements this is because a real user would not be able to interact with non visible elements note all searches in capybara are case sensitive this is because capybara heavily uses xpath which doesnt support case insensitivity navigating you can use the visit method to navigate to other pages ruby visit projects visit post comments path post the visit method only takes a single parameter the request method is always get you can get the current path of the browsing session and test it using the have current path matcher ruby expect page to have current path post comments path post note you can also assert the current path by testing the value of current path directly however using the have current path matcher is safer since it uses capybaras waiting behaviour to ensure that preceding actions such as a click link have completed clicking links and buttons full reference capybara node actions you can interact with the webapp by following links and buttons capybara automatically follows any redirects and submits forms associated with buttons ruby click link id of link click link link text click button save click on link text clicks on either links or buttons click on button value interacting with forms full reference capybara node actions there are a number of tools for interacting with form elements ruby fill in first name with john fill in password with seekrit fill in description with really long text choose a radio button check a checkbox uncheck a checkbox attach file image path to image jpg select option from select box querying full reference capybara node matchers capybara has a rich set of options for querying the page for the existence of certain elements and working with and manipulating those elements ruby page has selector table tr page has selector xpath table tr page has xpath table tr page has css table tr foo page has content foo note the negative forms like has no selector are different from not has selector read the section on asynchronous javascript for an explanation you can use these with rspecs magic matchers ruby expect page to have selector table tr expect page to have selector xpath table tr expect page to have xpath table tr expect page to have css table tr foo expect page to have content foo finding full reference capybara node finders you can also find specific elements in order to manipulate them ruby find field first name value find field id my field value find link hello visible all visible find link class some class some other class visible all visible find button send click find button value 1234 click find xpath table tr click find overlay find h1 click all a each a a href if you need to find elements by additional attributes properties you can also pass a filter block which will be checked inside the normal waiting behavior if you find yourself needing to use this a lot you may be better off adding a custom selector or adding a filter to an existing selector ruby find field first name el el data xyz 123 find img loading img img complete true note find will wait for an element to appear on the page as explained in the ajax section if the element does not appear it will raise an error these elements all have all the capybara dsl methods available so you can restrict them to specific parts of the page ruby find navigation click link home expect find navigation to have button sign out scoping capybara makes it possible to restrict certain actions such as interacting with forms or clicking links and buttons to within a specific area of the page for this purpose you can use the generic within method optionally you can specify which kind of selector to use ruby within li employee do fill in name with jimmy end within xpath li id employee do fill in name with jimmy end there are special methods for restricting the scope to a specific fieldset identified by either an id or the text of the fieldsets legend tag and to a specific table identified by either id or text of the tables caption tag ruby within fieldset employee do fill in name with jimmy end within table employee do fill in name with jimmy end working with windows capybara provides some methods to ease finding and switching windows ruby facebook window window opened by do click button like end within window facebook window do find login email set a example com find login password set qwerty click button submit end scripting in drivers which support it you can easily execute javascript ruby page execute script body empty for simple expressions you can return the result of the script note that this may break with more complicated expressions ruby result page evaluate script 4 4 modals in drivers which support it you can accept dismiss and respond to alerts confirms and prompts you can accept or dismiss alert messages by wrapping the code that produces an alert in a block ruby accept alert do click link show alert end you can accept or dismiss a confirmation by wrapping it in a block as well ruby dismiss confirm do click link show confirm end you can accept or dismiss prompts as well and also provide text to fill in for the response ruby accept prompt with linus torvalds do click link show prompt about linux end all modal methods return the message that was presented so you can access the prompt message by assigning the return to a variable ruby message accept prompt with linus torvalds do click link show prompt about linux end expect message to eq who is the chief architect of linux debugging it can be useful to take a snapshot of the page as it currently is and take a look at it ruby save and open page you can also retrieve the current state of the dom as a string using page html ruby print page html this is mostly useful for debugging you should avoid testing against the contents of page html and use the more expressive finder methods instead finally in drivers that support it you can save a screenshot ruby page save screenshot screenshot png or have it save and automatically open ruby save and open screenshot screenshots are saved to capybara save path relative to the app directory if you have required capybara rails capybara save path will default to tmp capybara matching it is possible to customize how capybara finds elements at your disposal are two options capybara exact and capybara match exactness capybara exact and the exact option work together with the is expression inside the xpath gem when exact is true all is expressions match exactly when it is false they allow substring matches many of the selectors built into capybara use the is expression this way you can specify whether you want to allow substring matches or not capybara exact is false by default for example ruby click link password also matches password confirmation capybara exact true click link password does not match password confirmation click link password exact false can be overridden strategy using capybara match and the equivalent match option you can control how capybara behaves when multiple elements all match a query there are currently four different strategies built into capybara first just picks the first element that matches one raises an error if more than one element matches smart if exact is true raises an error if more than one element matches just like one if exact is false it will first try to find an exact match an error is raised if more than one element is found if no element is found a new search is performed which allows partial matches if that search returns multiple matches an error is raised prefer exact if multiple matches are found some of which are exact and some of which are not then the first exactly matching element is returned the default for capybara match is smart to emulate the behaviour in capybara 2 0 x set capybara match to one to emulate the behaviour in capybara 1 x set capybara match to prefer exact transactions and database setup note rails 5 1 safely shares the database connection between the app and test threads therefore if using rails 5 1 you should be able to ignore this section some capybara drivers need to run against an actual http server capybara takes care of this and starts one for you in the same process as your test but on another thread selenium is one of those drivers whereas racktest is not if you are using a sql database it is common to run every test in a transaction which is rolled back at the end of the test rspec rails does this by default out of the box for example since transactions are usually not shared across threads this will cause data you have put into the database in your test code to be invisible to capybara cucumber handles this by using truncation instead of transactions i e they empty out the entire database after each test you can get the same behaviour by using a gem such as database cleaner asynchronous javascript ajax and friends when working with asynchronous javascript you might come across situations where you are attempting to interact with an element which is not yet present on the page capybara automatically deals with this by waiting for elements to appear on the page when issuing instructions to the dsl such as ruby click link foo click link bar expect page to have content baz if clicking on the foo link triggers an asynchronous process such as an ajax request which when complete will add the bar link to the page clicking on the bar link would be expected to fail since that link doesnt exist yet however capybara is smart enough to retry finding the link for a brief period of time before giving up and throwing an error the same is true of the next line which looks for the content baz on the page it will retry looking for that content for a brief time you can adjust how long this period is the default is 2 seconds ruby capybara default max wait time 5 be aware that because of this behaviour the following two statements are not equivalent and you should always use the latter ruby page has xpath a page has no xpath a the former would immediately fail because the content has not yet been removed only the latter would wait for the asynchronous process to remove the content from the page capybaras rspec matchers however are smart enough to handle either form the two following statements are functionally equivalent ruby expect page not to have xpath a expect page to have no xpath a capybaras waiting behaviour is quite advanced and can deal with situations such as the following line of code ruby expect find sidebar find h1 to have content something even if javascript causes sidebar to disappear off the page capybara will automatically reload it and any elements it contains so if an ajax request causes the contents of sidebar to change which would update the text of the h1 to something and this happened this test would pass if you do not want this behaviour you can set capybara automatic reload to false using the dsl elsewhere you can mix the dsl into any context by including capybara dsl ruby require capybara dsl capybara default driver webkit module mymodule include capybara dsl def login within xpath form id session do fill in email with user example com fill in password with password end click button sign in end end this enables its use in unsupported testing frameworks and for general purpose scripting calling remote servers normally capybara expects to be testing an in process rack application but you can also use it to talk to a web server running anywhere on the internet by setting app host ruby capybara current driver selenium capybara app host http www google com visit note the default driver rack test does not support running against a remote server with drivers that support it you can also visit any url directly ruby visit http www google com by default capybara will try to boot a rack application automatically you might want to switch off capybaras rack server if you are running against a remote application ruby capybara run server false using sessions capybara manages named sessions default if not specified allowing multiple sessions using the same driver and test app instance to be interacted with a new session will be created using the current driver if a session with the given name using the current driver and test app instance is not found named sessions to perform operations in a different session and then revert to the previous session ruby capybara using session bobs session do do something in bobs browser session end reverts to previous session to permanently switch the current session to a different session ruby capybara session name some other session using sessions manually for ultimate control you can instantiate and use a session manually ruby require capybara session capybara session new webkit my rack app session within form session do session fill in email with user example com session fill in password with password end session click button sign in xpath css and selectors capybara does not try to guess what kind of selector you are going to give it and will always use css by default if you want to use xpath youll need to do ruby within xpath ul li find xpath ul li text find xpath li contains a href text foo value alternatively you can set the default selector to xpath ruby capybara default selector xpath find ul li text capybara allows you to add custom selectors which can be very useful if you find yourself using the same kinds of selectors very often ruby capybara add selector id do xpath id xpath descendant xpath attr id id to s end capybara add selector row do xpath num tbody tr num end capybara add selector flash type do css type flash type end the block given to xpath must always return an xpath expression as a string or an xpath expression generated through the xpath gem you can now use these selectors like this ruby find id post 123 find row 3 find flash type notice beware the xpath trap in xpath the expression means something very specific and it might not be what you think contrary to common belief means anywhere in the document not anywhere in the current context as an example ruby page find xpath body all xpath script you might expect this to find all script tags in the body but actually it finds all script tags in the entire document not only those in the body what youre looking for is the expression which means any descendant of the current node ruby page find xpath body all xpath script the same thing goes for within ruby within xpath body do page find xpath script within xpath table tbody do end end configuring and adding drivers capybara makes it convenient to switch between different drivers it also exposes an api to tweak those drivers with whatever settings you want or to add your own drivers this is how to override the selenium driver configuration to use chrome ruby capybara register driver selenium do app capybara selenium driver new app browser chrome end however its also possible to give this configuration a different name ruby capybara register driver selenium chrome do app capybara selenium driver new app browser chrome end then tests can switch between using different browsers effortlessly ruby capybara current driver selenium chrome whatever is returned from the block should conform to the api described by capybara driver base it does not however have to inherit from this class gems can use this api to add their own drivers to capybara the selenium wiki has additional info about how the underlying driver can be configured gotchas access to session and request is not possible from the test access to response is limited some drivers allow access to response headers and http status code but this kind of functionality is not provided by some drivers such as selenium access to rails specific stuff such as controller is unavailable since were not using rails integration testing freezing time its common practice to mock out the time so that features that depend on the current date work as expected this can be problematic on ruby platform combinations that dont support access to a monotonic process clock since capybaras ajax timing uses the system time resulting in capybara never timing out and just hanging when a failure occurs its still possible to use gems which allow you to travel in time rather than freeze time one such gem is timecop when using rack test beware if attempting to visit absolute urls for example a session might not be shared between visits to posts path and posts url if testing an absolute url in an action mailer email set default url options to match the rails default of www example com server errors will only be raised in the session that initiates the server thread if you are testing for specific server errors and using multiple sessions make sure to test for the errors using the initial session usually default threadsafe mode in normal mode most of capybaras configuration options are global settings which can cause issues if using multiple sessions and wanting to change a setting for only one of the sessions to provide support for this type of usage capybara now provides a threadsafe mode which can be enabled by setting ruby capybara threadsafe true this setting can only be changed before any sessions have been created in threadsafe mode the following behaviors of capybara change most options can now be set on a session these can either be set at session creation time or after and default to the global options at the time of session creation options which are not session specific are app reuse server default driver javascript driver and obviously threadsafe any drivers and servers registered through register driver and register server are also global ruby my session capybara session new driver some app do config config automatic label click true only set for my session end my session config default max wait time 10 only set for my session capybara default max wait time 2 will not change the default max wait in my session current driver and session name are thread specific this means that using session and using driver also only affect the current thread development to set up a development environment simply do bash bundle install bundle exec rake run the test suite with firefox requires geckodriver to be installed bundle exec rake spec chrome run the test suite with chrome require chromedriver to be installed see contributing md for how to send issues and pull requests