nock nock is an http server mocking and expectations library for node js nock can be used to test modules that perform http requests in isolation for instance if a module performs http requests to a couchdb server or makes http requests to the amazon api you can test that module in isolation table of contents toc how does it work install node version support usage read this about interceptors specifying hostname specifying path specifying request body specifying request query string specifying replies access original request and headers replying with errors specifying headers header field names are case insensitive specifying request headers specifying reply headers default reply headers including content length header automatically including date header automatically http verbs support for http and https non standard ports repeat response n times delay the response body delay the response delay the connection socket timeout chaining scope filtering path filtering request body filtering request headers matching optional requests allow unmocked requests on a mocked hostname expectations isdone cleanall persist pendingmocks activemocks isactive logging restoring activating turning nock off experimental enable disable real http request recording dont print option output objects option enable reqheaders recording option logging option use separator option removeinterceptor events global no match event nock back setup options usage options modes debugging protip contributing license tocstop how does it work nock works by overriding nodes http request function also it overrides http clientrequest too to cover for modules that use it directly install sh npm install save nock node version support node nock 0 10 up to 8 x 0 11 up to 8 x 0 12 up to 8 x 4 9 x 5 up to 8 x 6 9 x usage on your test you can setup your mocking object like this js var nock require nock var couchdb nock http myapp iriscouch com get users 1 reply 200 id 123abc rev 946b7d1c username pgte email pedro teixeira gmail com this setup says that we will intercept every http call to http myapp iriscouch com it will intercept an http get request to users 1 and reply with a status 200 and the body will contain a user representation in json then the test can call the module and the module will do the http requests read this about interceptors when you setup an interceptor for a url and that interceptor is used it is removed from the interceptor list this means that you can intercept 2 or more calls to the same url and return different things on each of them it also means that you must setup one interceptor for each request you are going to have otherwise nock will throw an error because that url was not present in the interceptor list if you dont want interceptors to be removed as they are used you can use the persist method specifying hostname the request hostname can be a string or a regexp js var scope nock http www example com get resource reply 200 domain matched js var scope nock example\ com get resource reply 200 domain regex matched note you can choose to include or not the protocol in the hostname matching specifying path the request path can be a string a regexp or a filter function and you can use any http verb using a string js var scope nock http www example com get resource reply 200 path matched using a regular expression js var scope nock http www example com get source reply 200 path using regex matched using a function js var scope nock http www example com get function uri return uri indexof cats 0 reply 200 path using function matched specifying request body you can specify the request body to be matched as the second argument to the get post put or delete specifications there are four types of second argument allowed string nock will exact match the stringified request body with the provided string js nock http www example com post login username pgte password 123456 reply 200 id 123abc regexp nock will test the stringified request body against the provided regexp js nock http www example com post login username \w gi reply 200 id 123abc json object nock will exact match the request body with the provided object in order to increase flexibility nock also supports regexp as an attribute value for the keys js nock http www example com post login username pgte password i reply 200 id 123abc function nock will evaluate the function providing the request body object as first argument return true if it should be considered a match js nock http www example com post login function body return body username body password reply 200 id 123abc in case you need to perform a partial matching on a complex nested request body you should have a look at libraries like lodash matches indeed partial matching can be achieved as js nock http www example com post user matches address country us reply 200 id 123abc specifying request query string nock understands query strings instead of placing the entire url you can specify the query part as an object js nock http example com get users query name pedro surname teixeira reply 200 results id pgte nock supports array style object style query parameters the encoding format matches with request module js nock http example com get users query names alice bob tags alice admin tester bob tester reply 200 results id pgte nock supports passing a function to query the function determines if the actual query matches or not js nock http example com get users query function actualqueryobject do some compare with the actual query object return true for matched return false for not matched return true reply 200 results id pgte to mock the entire url regardless of the passed query string js nock http example com get users query true reply 200 results id pgte specifying replies you can specify the return status code for a path on the first argument of reply like this js var scope nock http myapp iriscouch com get users 1 reply 404 you can also specify the reply body as a string js var scope nock http www google com get reply 200 hello from google or as a json encoded object js var scope nock http myapp iriscouch com get reply 200 username pgte email pedro teixeira gmail com id 4324243fsd or even as a file js var scope nock http myapp iriscouch com get replywithfile 200 dirname replies user json content type application json instead of an object or a buffer you can also pass in a callback to be evaluated for the value of the response body js var scope nock http www google com filteringrequestbody post echo reply 201 function uri requestbody return requestbody an asynchronous function that gets an error first callback as last argument also works js var scope nock http www google com filteringrequestbody post echo reply 201 function uri requestbody cb fs readfile cat poems txt cb error first callback note when using a callback if you call back with an error as first argument that error will be sent in the response body with a 500 http response status code you can also return the status code and body using just one function js var scope nock http www google com filteringrequestbody post echo reply function uri requestbody return 201 this is the reply body header value optional headers or use an error first callback that also gets the status code js var scope nock http www google com filteringrequestbody post echo reply function uri requestbody cb settimeout function cb null 201 this is the reply body 1e3 a stream works too js var scope nock http www google com get cat poems reply 200 function uri requestbody return fs createreadstream cat poems txt access original request and headers if youre using the reply callback style you can access the original client request using this req like this js var scope nock http www google com get cat poems reply function uri requestbody console log path this req path console log headers this req headers replying with errors you can reply with an error like this js nock http www google com get cat poems replywitherror something awful happened json error responses are allowed too js nock http www google com get cat poems replywitherror message something awful happened code awful error note this will emit an error event on the request object not the reply specifying headers header field names are case insensitive per http 1 1 4 2 message headers specification all message headers are case insensitive and thus internally nock uses lower case for all field names even if some other combination of cases was specified either in mocking specification or in mocked requests themselves specifying request headers you can specify the request headers like this js var scope nock http www example com reqheaders authorization basic auth get reply 200 or you can use a regular expression or function check the header values the function will be passed the header value js var scope nock http www example com reqheaders x my headers function headervalue if headervalue return true return false x my awesome header awesome i get reply 200 if reqheaders is not specified or if host is not part of it nock will automatically add host value to request header if no request headers are specified for mocking then nock will automatically skip matching of request headers since host header is a special case which may get automatically inserted by nock its matching is skipped unless it was also specified in the request being mocked you can also have nock fail the request if certain headers are present js var scope nock http www example com badheaders cookie x forwarded for get reply 200 when invoked with this option nock will not match the request if any of the badheaders are present basic authentication can be specified as follows js var scope nock http www example com get basicauth user john pass doe reply 200 specifying reply headers you can specify the reply headers like this js var scope nock http www headdy com get reply 200 hello world x my headers my header value or you can use a function to generate the headers values the function will be passed the request response and body if available the body will be either a buffer a stream or undefined js var scope nock http www headdy com get reply 200 hello world x my headers function req res body return body tostring default reply headers you can also specify default reply headers for all responses like this js var scope nock http www headdy com defaultreplyheaders x powered by rails content type application json get reply 200 the default headers should come too or you can use a function to generate the default headers values js var scope nock http www headdy com defaultreplyheaders content length function req res body return body length get reply 200 the default headers should come too including content length header automatically when using scope reply to set a response body manually you can have the content length header calculated automatically js var scope nock http www headdy com replycontentlength get reply 200 hello world note this does not work with streams or other advanced means of specifying the reply body including date header automatically you can automatically append a date header to your mock reply js var scope nock http www headdy com replydate new date 2015 0 1 defaults to now must use a date object get reply 200 hello world http verbs nock supports any http verb and it has convenience methods for the get post put head delete patch and merge http verbs you can intercept any http verb using intercept path verb requestbody options js var scope nock http my domain com intercept path patch reply 304 support for http and https by default nock assumes http if you need to use https you can specify the https prefix like this js var scope nock https secure my server com non standard ports you are able to specify a non standard port like this js var scope nock http my server com 8081 repeat response n times you are able to specify the number of times to repeat the same response js nock http zombo com get times 4 reply 200 ok http get http zombo com respond body ok http get http zombo com respond body ok http get http zombo com respond body ok http get http zombo com respond body ok http get http zombo com respond with zombo com result sugar syntax js nock http zombo com get once reply 200 ok nock http zombo com get twice reply 200 ok nock http zombo com get thrice reply 200 ok delay the response body you are able to specify the number of milliseconds that the response body should be delayed response header will be replied immediately delaybody 1000 is equivalent to delay body 1000 js nock http my server com get delaybody 2000 2 seconds reply 200 html html note the response event will occur immediately but the incomingmessage will not emit its end event until after the delay delay the response you are able to specify the number of milliseconds that your reply should be delayed js nock http my server com get delay 2000 2 seconds delay will be applied to the response header reply 200 html html delay could also be used as delay head headdelayinms body bodydelayinms for example js nock http my server com get delay head 2000 header will be delayed for 2 seconds i e the whole response will be delayed for 2 seconds body 3000 body will be delayed for another 3 seconds after header is sent out reply 200 html html delay the connection delayconnection 1000 is equivalent to delay head 1000 socket timeout you are able to specify the number of milliseconds that your connection should be idle to simulate a socket timeout js nock http my server com get socketdelay 2000 2 seconds reply 200 html html to test a request like the following js req http request http my server com function res req settimeout 1000 function req abort req end note the timeout will be fired immediately and will not leave the simulated connection idle for the specified period of time chaining you can chain behaviour like this js var scope nock http myapp iriscouch com get users 1 reply 404 post users username pgte email pedro teixeira gmail com reply 201 ok true id 123abc rev 946b7d1c get users 123abc reply 200 id 123abc rev 946b7d1c username pgte email pedro teixeira gmail com scope filtering you can filter the scope protocol domain or port of nock through a function the filtering function is accepted at the filteringscope field of the options argument this can be useful if you have a node module that randomly changes subdomains to which it sends requests e g the dropbox node module behaves like this js var scope nock https api dropbox com filteringscope function scope return https \ \ api 0 9 dropbox com test scope get 1 metadata auto photos include deleted false list true reply 200 path filtering you can also filter the urls based on a function this can be useful for instance if you have random or time dependent data in your url you can use a regexp for replacement just like string prototype replace js var scope nock http api myservice com filteringpath password g password xxx get users 1 password xxx reply 200 user or you can use a function js var scope nock http api myservice com filteringpath function path return abc get abc reply 200 user note that scope filteringpath is not cumulative it should only be used once per scope request body filtering you can also filter the request body based on a function this can be useful for instance if you have random or time dependent data in your request body you can use a regexp for replacement just like string prototype replace js var scope nock http api myservice com filteringrequestbody password g password xxx post users 1 data abc password xxx reply 201 ok or you can use a function to transform the body js var scope nock http api myservice com filteringrequestbody function body return abc post abc reply 201 ok request headers matching if you need to match requests only if certain request headers match you can js var scope nock http api myservice com matchheader accept application json get reply 200 data hello world you can also use a regexp for the header body js var scope nock http api myservice com matchheader user agent mozilla\ get reply 200 data hello world you can also use a function for the header body js var scope nock http api myservice com matchheader content length function val return val 1000 get reply 200 data hello world optional requests by default every mocked request is expected to be made exactly once and until it is itll appear in scope pendingmocks and scope isdone will return false see expectations in many cases this is fine but in some especially cross test setup code its useful to be able to mock a request that may or may not happen you can do this with optionally optional requests are consumed just like normal ones once matched but they do not appear in pendingmocks and isdone will return true for scopes with only optional requests pending js var example nock http example com example pendingmocks example get patha reply 200 example pendingmocks get http example com 80 path after a request to example com patha example pendingmocks example get pathb optionally reply 200 example pendingmocks allow unmocked requests on a mocked hostname if you need some request on the same host name to be mocked and some others to really go through the http stack you can use the allowunmocked option like this js options allowunmocked true var scope nock http my existing service com options get my url reply 200 ok get my url goes through nock get other url actually makes request to the server note when applying allowunmocked true if the request is made to the real server no interceptor is removed expectations every time an http request is performed for a scope that is mocked nock expects to find a handler for it if it doesnt it will throw an error calls to nock return a scope which you can assert by calling scope done this will assert that all specified calls on that scope were performed example js var google nock http google com get reply 200 hello from google do some stuff settimeout function google done will throw an assertion error if meanwhile a get http google com was not performed 5000 isdone you can call isdone on a single expectation to determine if the expectation was met js var scope nock http google com get reply 200 scope isdone will return false it is also available in the global scope which will determine if all expectations have been met js nock isdone cleanall you can cleanup all the prepared mocks could be useful to cleanup some state after a failed test like this js nock cleanall persist you can make all the interceptors for a scope persist by calling persist on it js var scope nock http persisssists con persist get reply 200 persisting all the way note that while a persisted scope will always intercept the requests it is considered done after the first interception if you want to stop persisting a persistent nock you can call persist false js var scope nock http example com persist get reply 200 ok do some tests scope persist false pendingmocks if a scope is not done you can inspect the scope to infer which ones are still pending using the scope pendingmocks function js if scope isdone console error pending mocks j scope pendingmocks it is also available in the global scope js console error pending mocks j nock pendingmocks activemocks you can see every mock that is currently active i e might potentially reply to requests in a scope using scope activemocks a mock is active if it is pending optional but not yet completed or persisted mocks that have intercepted their requests and are no longer doing anything are the only mocks which wont appear here you probably dont need to use this it mainly exists as a mechanism to recreate the previous now changed behavior of pendingmocks js console error active mocks j scope activemocks it is also available in the global scope js console error active mocks j nock activemocks isactive your tests may sometimes want to deactivate the nock interceptor once deactivated nock needs to be re activated to work you can check if nock interceptor is active or not by using nock isactive sample js if nock isactive nock activate logging nock can log matches if you pass in a log function like this js var google nock http google com log console log restoring you can restore the http interceptor to the normal unmocked behaviour by calling js nock restore note 1 restore does not clear the interceptor list use nock cleanall if you expect the interceptor list to be empty note 2 restore will also remove the http interceptor itself you need to run nock activate to re activate the http interceptor without re activation nock will not intercept any calls activating only for cases where nock has been deactivated using nock restore you can reactivate the http interceptor to start intercepting http calls using js nock activate note to check if nock http interceptor is active or deactive use nock isactive turning nock off experimental you can bypass nock completely by setting nock off environment variable to true this way you can have your tests hit the real servers just by switching on this environment variable js nock off true node my test js enable disable real http request by default any requests made to a host that is not mocked will be executed normally if you want to block these requests nock allows you to do so for disabling real http requests js nock disablenetconnect so if you try to request any host not nocked it will thrown an netconnectnotallowederror js nock disablenetconnect var req http get http google com req on error function err console log err the returned http clientrequest will emit an error event or throw if youre not listening for it this code will log a netconnectnotallowederror with message nock not allow net connect for google com 80 for enabling real http requests the default behaviour js nock enablenetconnect you could allow real http request for certain host names by providing a string or a regular expression for the hostname js using a string nock enablenetconnect amazon com or a regexp nock enablenetconnect amazon github com http get http www amazon com http get http github com only for second example this request will be done http get http google com this will throw netconnectnotallowederror with message nock not allow net connect for google com 80 a common use case when testing local endpoints would be to disable all but local host then adding in additional nocks for external requests js nock disablenetconnect nock enablenetconnect 127 0 0 1 allow localhost connections so we can test local routes and mock servers then when youre done with the test you probably want to set everything back to normal js nock cleanall nock enablenetconnect recording this is a cool feature guessing what the http calls are is a mess especially if you are introducing nock on your already coded tests for these cases where you want to mock an existing live system you can record and playback the http calls like this js nock recorder rec some http calls happen and the nock code necessary to mock those calls will be outputted to console recording relies on intercepting real requests and answers and then persisting them for later use in order to stop recording you should call nock restore and recording will stop attention when recording is enabled nock does no validation nor will any mocks be enabled please be sure to turn off recording before attempting to use any mocks in your tests dont print option if you just want to capture the generated code into a var as an array you can use js nock recorder rec dont print true some http calls var nockcalls nock recorder play the nockcalls var will contain an array of strings representing the generated code you need copy and paste that code into your tests customize at will and youre done you can call nock recorder reset to remove already recorded calls from the array that nock recorder play returns remember that you should do this one test at a time output objects option in case you want to generate the code yourself or use the test data in some other way you can pass the output objects option to rec js nock recorder rec output objects true some http calls var nockcallobjects nock recorder play the returned call objects have the following properties scope the scope of the call including the protocol and non standard ports e g https github com 12345 method the http verb of the call e g get path the path of the call e g pgte nock body the body of the call if any status the http status of the reply e g 200 response the body of the reply which can be a json string hex string representing binary buffers or an array of such hex strings when handling content encoded in reply header headers the headers of the reply reqheader the headers of the request if you save this as a json file you can load them directly through nock load path then you can post process them before using them in the tests for example to add them request body filtering shown here fixing timestamps to match the ones captured during recording js nocks nock load pathtojson nocks foreach function nock nock filteringrequestbody function body arecordedbody if typeof body string typeof arecordedbody string return body var recordedbodyresult timestamp 0 9 exec arecordedbody if recordedbodyresult return body var recordedtimestamp recordedbodyresult 1 return body replace timestamp 0 9 g function match key value return key recordedtimestamp alternatively if you need to pre process the captured nock definitions before using them e g to add scope filtering then you can use nock loaddefs path and nock define nockdefs shown here is scope filtering for dropbox node module which constantly changes the subdomain to which it sends the requests js pre process the nock definitions as scope filtering has to be defined before the nocks are defined due to its very hacky nature var nockdefs nock loaddefs pathtojson nockdefs foreach function def do something with the definition object e g scope filtering def options def options def options filteringscope function scope return https \ \ api 0 9 dropbox com test scope load the nocks from pre processed definitions var nocks nock define nockdefs enable reqheaders recording option recording request headers by default is deemed more trouble than its worth as some of them depend on the timestamp or other values that may change after the tests have been recorder thus leading to complex postprocessing of recorded tests thus by default the request headers are not recorded the genuine use cases for recording request headers e g checking authorization can be handled manually or by using enable reqheaders recording in recorder rec options js nock recorder rec dont print true output objects true enable reqheaders recording true note that even when request headers recording is enabled nock will never record user agent headers user agent values change with the version of node and underlying operating system and are thus useless for matching as all that they can indicate is that the user agent isnt the one that was used to record the tests logging option nock will print using console log by default assuming that dont print is false if a different function is passed into logging nock will send the log string or object when using output objects to that function heres a basic example js var appendlogtofile function content fs appendfile record txt content nock recorder rec logging appendlogtofile use separator option by default nock will wrap its output with the separator string cut here before and after anything it prints whether to the console or a custom log function given with the logging option to disable this set use separator to false js nock recorder rec use separator false removeinterceptor this allows removing a specific interceptor this can be either an interceptor instance or options for a url its useful when theres a list of common interceptors shared between tests where an individual test requires one of the shared interceptors to behave differently examples js nock removeinterceptor hostname localhost path mockedresource js nock removeinterceptor hostname localhost path login method post proto https js var interceptor nock http example org get somepath nock removeinterceptor interceptor events a scope emits the following events emit request function req interceptor body emit replied function req interceptor global no match event you can also listen for no match events like this js nock emitter on no match function req nock back fixture recording support and playback setup you must specify a fixture directory before using for example in your test helper javascript var nockback require nock back nockback fixtures path to fixtures nockback setmode record options nockback fixtures path to fixture directory nockback setmode the mode to use usage by default if the fixture doesnt exist a nockback will create a new fixture and save the recorded output for you the next time you run the test if the fixture exists it will be loaded in the this context of the callback function will have a property scopes to access all of the loaded nock scopes javascript var nockback require nock back var request require request nockback setmode record nockback fixtures dirname nockfixtures this only needs to be set once in your test helper var before function scope scope filteringrequestbody function body arecordedbody if typeof body string typeof arecordedbody string return body var recordedbodyresult timestamp 0 9 exec arecordedbody if recordedbodyresult return body var recordedtimestamp recordedbodyresult 1 return body replace timestamp 0 9 g function match key value return key recordedtimestamp recording of the fixture nockback zombofixture json function nockdone request get http zombo com function err res body nockdone usage of the created fixture nockback zombofixture json function nockdone http get http zombo com end respond body ok this assertscopesfinished throws an exception if all nocks in fixture were not satisfied http get http zombo com end throws exception because somefixture json only had one call nockdone never gets here if your tests are using promises then use nockback like this return nockback promisedfixture json then nockdone context do your tests returning a promise and chain it with then nockdone options as an optional second parameter you can pass the following options before a preprocessing function gets called before nock define after a postprocessing function gets called after nock define afterrecord a postprocessing function gets called after recording is passed the array of scopes recorded and should return the array scopes to save to the fixture recorder custom options to pass to the recorder modes to set the mode call nockback setmode mode or run the tests with the nock back mode environment variable set before loading nock if the mode needs to be changed programatically the following is valid nockback setmode nockback currentmode wild all requests go out to the internet dont replay anything doesnt record anything dryrun the default use recorded nocks allow http calls doesnt record anything useful for writing new tests record use recorded nocks record new nocks lockdown use recorded nocks disables all http calls even when not nocked doesnt record debugging nock uses debug so just run with environmental variable debug set to nock js debug nock node my test js protip if you dont want to match the request body you can use this trick by theycallmeswift js var scope nock http api myservice com filteringrequestbody function body return post some uri reply 200 ok contributing thanks for wanting to contribute take a look at our contributing guide for notes on our commit message conventions and how to run tests please note that this project is released with a contributor code of conduct by participating in this project you agree to abide by its terms license mit copyright c 2011 2017 pedro teixeira and other contributors