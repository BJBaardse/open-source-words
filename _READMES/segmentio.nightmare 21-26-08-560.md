nightmare nightmare is a high level browser automation library from segment the goal is to expose a few simple methods that mimic user actions like goto type and click with an api that feels synchronous for each block of scripting rather than deeply nested callbacks it was originally designed for automating tasks across sites that dont have apis but is most often used for ui testing and crawling under the covers it uses electron which is similar to phantomjs but roughly twice as fast and more modern ‚ö†Ô∏è security warning weve implemented many of the security recommendations outlined by electron to try and keep you safe but undiscovered vulnerabilities may exist in electron that could allow a malicious website to execute code on your computer avoid visiting untrusted websites üõ† migrating to 3 x youll want to check out this issue before upgrading weve worked hard to make improvements to nightmare while limiting the breaking changes and theres a good chance you wont need to do anything niffy is a perceptual diffing tool built on nightmare it helps you detect ui changes and bugs across releases of your web app daydream is a complementary chrome extension built by stevenmiller888 that generates nightmare scripts for you while you browse many thanks to matthewmueller and rosshinkley for their help on nightmare examples ui testing quick start perceptual diffing with niffy nightmare api set up an instance interact with the page extract from the page cookies proxies promises extending nightmare usage debugging additional resources examples lets search on duckduckgo js const nightmare require nightmare const nightmare nightmare show true nightmare goto https duckduckgo com type search form input homepage github nightmare click search button homepage wait r1 0 a resulta evaluate document queryselector r1 0 a resulta href end then console log catch error console error search failed error you can run this with shell npm install save nightmare node example js or lets run some mocha tests js const nightmare require nightmare const chai require chai const expect chai expect describe test duckduckgo search results it should find the nightmare github link first function done this timeout 10s const nightmare nightmare nightmare goto https duckduckgo com type search form input homepage github nightmare click search button homepage wait links result a evaluate document queryselector links result a href end then link expect link to equal https github com segmentio nightmare done you can see examples of every function in the tests here to get started with ui testing check out this quick start guide to install dependencies npm install to run the mocha tests npm test node versions nightmare is intended to be run on nodejs 4 x or higher api nightmare options creates a new instance that can navigate around the web the available options are documented here along with the following nightmare specific options waittimeout default 30s throws an exception if the wait didnt return true within the set timeframe js const nightmare nightmare waittimeout 1000 in ms gototimeout default 30s throws an exception if the goto didnt finish loading within the set timeframe note that even though goto normally waits for all the resources on a page to load a timeout exception is only raised if the dom itself has not yet loaded js const nightmare nightmare gototimeout 1000 in ms loadtimeout default infinite forces nightmare to move on if a page transition caused by an action eg click didnt finish within the set timeframe if loadtimeout is shorter than gototimeout the exceptions thrown by gototimeout will be suppressed js const nightmare nightmare loadtimeout 1000 in ms executiontimeout default 30s the maximum amount of time to wait for an evaluate statement to complete js const nightmare nightmare executiontimeout 1000 in ms paths the default system paths that electron knows about heres a list of available paths https github com atom electron blob master docs api app md appgetpathname you can overwrite them in nightmare by doing the following js const nightmare nightmare paths userdata user data switches the command line switches used by the chrome browser that are also supported by electron heres a list of supported chrome command line switches https github com atom electron blob master docs api chrome command line switches md js const nightmare nightmare switches proxy server 1 2 3 4 5678 ignore certificate errors true electronpath the path to the prebuilt electron binary this is useful for testing on different versions of electron note that nightmare only supports the version on which this package depends use this option at your own risk js const nightmare nightmare electronpath require electron dock os x a boolean to optionally show the electron icon in the dock defaults to false this is useful for testing purposes js const nightmare nightmare dock true opendevtools optionally shows the devtools in the electron window using true or use an object hash containing mode detach to show in a separate window the hash gets passed to contents opendevtools to be handled this is also useful for testing purposes note that this option is honored only if show is set to true js const nightmare nightmare opendevtools mode detach show true typeinterval default 100ms how long to wait between keystrokes when using type js const nightmare nightmare typeinterval 20 pollinterval default 250ms how long to wait between checks for the wait condition to be successful js const nightmare nightmare pollinterval 50 in ms maxauthretries default 3 defines the number of times to retry an authentication when set up with authenticate js const nightmare nightmare maxauthretries 3 certificatesubjectname a string to determine the client certificate selected by electron if this options is set the select client certificate event will be set to loop through the certificatelist and find the first certificate that matches subjectname on the electron certificate object js const nightmare nightmare certificatesubjectname tester engineversions gets the versions for electron and chromium useragent useragent sets the useragent used by electron authentication user password sets the user and password for accessing a web page using basic authentication be sure to set it before calling goto url end completes any queue operations disconnect and close the electron process note that if youre using promises then must be called after end to run the end task also note that if using an end callback the end call is equivalent to calling end followed by then fn consider js nightmare goto someurl end some value prints some value then console log halt error done clears all queued operations kills the electron process and passes error message or nightmare halted to an unresolved promise done will be called after the process has exited interact with the page goto url headers loads the page at url optionally a headers hash can be supplied to set headers on the goto request when a page load is successful goto returns an object with metadata about the page load including url the url that was loaded code the http status code e g 200 404 500 method the http method used e g get post referrer the page that the window was displaying prior to this load or an empty string if this is the first page load headers an object representing the response headers for the request as in header1 name header1 value header2 name header2 value if the page load fails the error will be an object with the following properties message a string describing the type of error code the underlying error code describing what went wrong note this is not the http status code for possible values see https code google com p chromium codesearch chromium src net base net error list h details a string with additional details about the error this may be null or an empty string url the url that failed to load note that any valid response from a server is considered ‚Äúsuccessful ‚Äù that means things like 404 ‚Äúnot found‚Äù errors are successful results for goto only things that would cause no page to appear in the browser window such as no server responding at the given address the server hanging up in the middle of a response or invalid urls are errors you can also adjust how long goto will wait before timing out by setting the gototimeout option on the nightmare constructor back goes back to the previous page forward goes forward to the next page refresh refreshes the current page click selector clicks the selector element once mousedown selector mousedowns the selector element once mouseup selector mouseups the selector element once mouseover selector mouseovers the selector element once mouseout selector mouseout the selector element once type selector text enters the text provided into the selector element empty or falsey values provided for text will clear the selectors value type mimics a user typing in a textbox and will emit the proper keyboard events key presses can also be fired using unicode values with type for example if you wanted to fire an enter key press you would write type body \u000d if you dont need the keyboard events consider using insert instead as it will be faster and more robust insert selector text similar to type insert enters the text provided into the selector element empty or falsey values provided for text will clear the selectors value insert is faster than type but does not trigger the keyboard events check selector checks the selector checkbox element uncheck selector unchecks the selector checkbox element select selector option changes the selector dropdown element to the option with attribute value option scrollto top left scrolls the page to desired position top and left are always relative to the top left corner of the document viewport width height sets the viewport size inject type file injects a local file onto the current page the file type must be either js or css evaluate fn arg1 arg2 invokes fn on the page with arg1 arg2 all the args are optional on completion it returns the return value of fn useful for extracting information from the page heres an example js const selector h1 nightmare evaluate selector now were executing inside the browser scope return document queryselector selector innertext selector thats how you pass parameters from node scope to browser scope then text error first callbacks are supported as a part of evaluate if the arguments passed are one fewer than the arguments expected for the evaluated function the evaluation will be passed a callback as the last parameter to the function for example js const selector h1 nightmare evaluate selector done now were executing inside the browser scope settimeout done null document queryselector selector innertext 2000 selector then text note that callbacks support only one value argument eg function err value ultimately the callback will get wrapped in a native promise and only be able to resolve a single value promises are also supported as a part of evaluate if the return value of the function has a then member evaluate assumes it is waiting for a promise for example js const selector h1 nightmare evaluate selector new promise resolve reject settimeout resolve document queryselector selector innertext 2000 selector then text wait ms waits for ms milliseconds e g wait 5000 wait selector waits until the element selector is present e g wait pay button wait fn arg1 arg2 waits until the fn evaluated on the page with arg1 arg2 returns true all the args are optional see evaluate for usage header header value adds a header override for all http requests if header is undefined the header overrides will be reset extract from the page exists selector returns whether the selector exists or not on the page visible selector returns whether the selector is visible or not on event callback captures page events with the callback you have to call on before calling goto supported events are documented here additional page events on page function type error message stack this event is triggered if any javascript exception is thrown on the page but this event is not triggered if the injected javascript code e g via evaluate is throwing an exception page events listens for window addeventlistener error alert prompt confirm on page function type error message stack listens for top level page errors this will get triggered when an error is thrown on the page on page function type alert message nightmare disables window alert from popping up by default but you can still listen for the contents of the alert dialog on page function type prompt message response nightmare disables window prompt from popping up by default but you can still listen for the message to come up if you need to handle the confirmation differently youll need to use your own preload script on page function type confirm message response nightmare disables window confirm from popping up by default but you can still listen for the message to come up if you need to handle the confirmation differently youll need to use your own preload script on console function type arguments type will be either log warn or error and arguments are what gets passed from the console this event is not triggered if the injected javascript code e g via evaluate is using console log once event callback similar to on but captures page events with the callback one time removelistener event callback removes a given listener callback for an event screenshot path clip takes a screenshot of the current page useful for debugging the output is always a png both arguments are optional if path is provided it saves the image to the disk otherwise it returns a buffer of the image data if clip is provided as documented here the image will be clipped to the rectangle html path savetype saves the current page as html as files to disk at the given path save type options are here pdf path options saves a pdf to the specified path options are here title returns the title of the current page url returns the url of the current page path returns the path name of the current page cookies cookies get name gets a cookie by its name the url will be the current url cookies get query queries multiple cookies with the query object if a query name is set it will return the first cookie it finds with that name otherwise it will query for an array of cookies if no query url is set it will use the current url heres an example js get all google cookies that are secure and have the path query nightmare goto http google com cookies get path query secure true then cookies do something with the cookies available properties are documented here https github com atom electron blob master docs api session md sescookiesgetdetails callback cookies get gets all the cookies for the current url if youd like get all cookies for all urls use get url null cookies set name value sets a cookies name and value this is the most basic form and the url will be the current url cookies set cookie sets a cookie if cookie url is not set it will set the cookie on the current url heres an example js nightmare goto http google com cookies set name token value some token path query secure true other actions then available properties are documented here https github com atom electron blob master docs api session md sescookiessetdetails callback cookies set cookies sets multiple cookies at once cookies is an array of cookie objects take a look at the cookies set cookie documentation above for a better idea of what cookie should look like cookies clear name clears a cookie for the current domain if name is not specified all cookies for the current domain will be cleared js nightmare goto http google com cookies clear somecookiename other actions then cookies clearall clears all cookies for all domains js nightmare goto http google com cookies clearall other actions then proxies proxies are supported in nightmare through switches if your proxy requires authentication you also need the authentication call the following example not only demonstrates how to use proxies but you can run it to test if your proxy connection is working js import nightmare from nightmare const proxynightmare nightmare switches proxy server my proxy server example com 8080 set the proxy server here show true proxynightmare authentication proxyusername proxypassword and authenticate here before goto goto http www ipchicken com evaluate return document queryselector b innertext replace \d g end then ip this will log the proxys ip console log proxy ip ip the rest is just normal nightmare to get your local ip const regularnightmare nightmare show true regularnightmare goto http www ipchicken com evaluate document queryselector b innertext replace \d g end then ip this will log the your local ip console log local ip ip promises by default nightmare uses default native es6 promises you can plug in your favorite es6 style promises library like bluebird or q for convenience heres an example js var nightmare require nightmare nightmare promise require bluebird or nightmare promise require q promise you can also specify a custom promise library per instance with the promise constructor option like so js var nightmare require nightmare var es6nightmare nightmare var bluebirdnightmare nightmare promise require bluebird var es6promise es6nightmare goto https github com segmentio nightmare then var bluebirdpromise bluebirdnightmare goto https github com segmentio nightmare then es6promise isfulfilled throws typeerror es6endpromise isfulfilled is not a function bluebirdpromise isfulfilled returns true false extending nightmare nightmare action name electronaction electronnamespace action namespace you can add your own custom actions to the nightmare prototype heres an example js nightmare action size function done this evaluate now const w math max document documentelement clientwidth window innerwidth 0 const h math max document documentelement clientheight window innerheight 0 return height h width w done nightmare goto http cnn com size then size do something with the size information remember this is attached to the static class nightmare not the instance youll notice we used an internal function evaluate now this function is different than nightmare evaluate because it runs it immediately whereas nightmare evaluate is queued an easy way to remember when in doubt use evaluate if youre creating custom actions use evaluate now the technical reason is that since our action has already been queued and were running it now we shouldnt re queue the evaluate function we can also create custom namespaces we do this internally for nightmare cookies get and nightmare cookies set these are useful if you have a bundle of actions you want to expose but it will clutter up the main nightmare object heres an example of that js nightmare action style background done this evaluate now window getcomputedstyle document body null backgroundcolor done nightmare goto http google com style background then background do something interesting with background you can also add custom electron actions the additional electron action or namespace actions take name options parent win renderer and done note the electron action comes first mirroring how evaluate works for example javascript nightmare action clearcache name options parent win renderer done parent respondto clearcache done win webcontents session clearcache done done function done this child call clearcache done nightmare clearcache goto http example org more actions then would clear the browsers cache before navigating to example org see this document for more details on creating custom actions use plugin nightmare use is useful for reusing a set of tasks on an instance check out nightmare swiftly for some examples custom preload script if you need to do something custom when you first load the window environment you can specify a custom preload script heres how you do that js import path from path const nightmare nightmare webpreferences preload path resolve custom script js alternative preload absolute path to custom script js the only requirement for that script is that youll need the following prelude js window nightmare nightmare ipc require electron ipcrenderer to benefit of all of nightmares feedback from the browser you can instead copy the contents of nightmares preload script storage persistence between nightmare instances by default nightmare will create an in memory partition for each instance this means that any localstorage or cookies or any other form of persistent state will be destroyed when nightmare is ended if you would like to persist state between instances you can use the webpreferences partition api in electron js import nightmare from nightmare nightmare nightmare non persistent paritition by default yield nightmare evaluate window localstorage setitem testing this will not be persisted end nightmare nightmare webpreferences partition persist testing yield nightmare evaluate window localstorage setitem testing this is persisted for other instances with the same paritition name end if you specify a null paritition then it will use the electron default behavior persistent or any string that starts with persist will persist under that partition name any other string will result in in memory only storage usage installation nightmare is a node js module so youll need to have node js installed then you just need to npm install the module bash npm install save nightmare execution nightmare is a node module that can be used in a node js script or module heres a simple script to open a web page js import nightmare from nightmare const nightmare nightmare nightmare goto http cnn com evaluate return document title end then title console log title if you save this as cnn js you can run it on the command line like this bash npm install save nightmare node cnn js common execution problems nightmare heavily relies on electron for heavy lifting and electron in turn relies on several ui focused dependencies eg libgtk which are often missing from server distros for help running nightmare on your server distro check out how to run nightmare on amazon linux and centos guide debugging there are three good ways to get more information about whats happening inside the headless browser use the debug flag described below pass show true to the nightmare constructor to have it create a visible rendered window where you can watch what is happening listen for specific events to run the same file with debugging output run it like this debug nightmare node cnn js on windows use set debug nightmare node cnn js this will print out some additional information about whats going on bash nightmare queueing action goto 0ms nightmare queueing action evaluate 4ms breaking news u s world weather entertainment video news cnn com debug flags all nightmare messages debug nightmare only actions debug nightmare actions only logs debug nightmare log additional resources ross hinkleys nightmare examples is a great resource for setting up nightmare learning about custom actions and avoiding common pitfalls nightmare issues has a bunch of standalone runnable examples the script numbers correspond to nightmare issue numbers nightmarishly good scraping is a great tutorial by √¶ndrew rininsland on getting up running with nightmare using real life data tests automated tests for nightmare itself are run using mocha and chai both of which will be installed via npm install to run nightmares tests just run make test when the tests are done youll see something like this bash make test ‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§‚Ä§ 18 passing 1m note that if you are using xvfb make test will automatically run the tests under an xvfb run wrapper if you are planning to run the tests headlessly without running xvfb first set the headless environment variable to 0 license mit wwwwww wwwwww w w w w w w oo \ o o mit \ \ copyright c 2015 segment io inc friends segment com permission is hereby granted free of charge to any person obtaining a copy of this software and associated documentation files the software to deal in the software without restriction including without limitation the rights to use copy modify merge publish distribute sublicense and or sell copies of the software and to permit persons to whom the software is furnished to do so subject to the following conditions the above copyright notice and this permission notice shall be included in all copies or substantial portions of the software the software is provided as is without warranty of any kind express or implied including but not limited to the warranties of merchantability fitness for a particular purpose and noninfringement in no event shall the authors or copyright holders be liable for any claim damages or other liability whether in an action of contract tort or otherwise arising from out of or in connection with the software or the use or other dealings in the software