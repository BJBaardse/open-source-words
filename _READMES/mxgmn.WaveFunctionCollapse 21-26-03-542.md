wavefunctioncollapse this program generates bitmaps that are locally similar to the input bitmap local similarity means that c1 each nxn pattern of pixels in the output should occur at least once in the input weak c2 distribution of nxn patterns in the input should be similar to the distribution of nxn patterns over a sufficiently large number of outputs in other words probability to meet a particular pattern in the output should be close to the density of such patterns in the input in the examples typical value of n is 3 wfc initializes output bitmap in a completely unobserved state where each pixel value is in superposition of colors of the input bitmap so if the input was black white then the unobserved states are shown in different shades of grey the coefficients in these superpositions are real numbers not complex numbers so it doesnt do the actual quantum mechanics but it was inspired by qm then the program goes into the observation propagation cycle on each observation step an nxn region is chosen among the unobserved which has the lowest shannon entropy this regions state then collapses into a definite state according to its coefficients and the distribution of nxn patterns in the input on each propagation step new information gained from the collapse on the previous step propagates through the output on each step the overall entropy decreases and in the end we have a completely observed state the wave function has collapsed it may happen that during propagation all the coefficients for a certain pixel become zero that means that the algorithm has run into a contradiction and can not continue the problem of determining whether a certain bitmap allows other nontrivial bitmaps satisfying condition c1 is np hard so its impossible to create a fast solution that always finishes in practice however the algorithm runs into contradictions surprisingly rarely watch a video demonstration of wfc algorithm on youtube https youtu be doqtr2xmlz0 algorithm read the input bitmap and count nxn patterns optional augment pattern data with rotations and reflections create an array with the dimensions of the output called wave in the source each element of this array represents a state of an nxn region in the output a state of an nxn region is a superpostion of nxn patterns of the input with boolean coefficients so a state of a pixel in the output is a superposition of input colors with real coefficients false coefficient means that the corresponding pattern is forbidden true coefficient means that the corresponding pattern is not yet forbidden initialize the wave in the completely unobserved state i e with all the boolean coefficients being true repeat the following steps observation find a wave element with the minimal nonzero entropy if there is no such elements if all elements have zero or undefined entropy then break the cycle 4 and go to step 5 collapse this element into a definite state according to its coefficients and the distribution of nxn patterns in the input propagation propagate information gained on the previous observation step by now all the wave elements are either in a completely observed state all the coefficients except one being zero or in the contradictive state all the coefficients being zero in the first case return the output in the second case finish the work without returning anything tilemap generation the simplest nontrivial case of the algorithm is when nxn 1x2 well nxm if we simplify it even further by storing not the probabilities of pairs of colors but the probabilities of colors themselves we get what we call a simple tiled model the propagation phase in this model is just adjacency constraint propagation its convenient to initialize the simple tiled model with a list of tiles and their adjacency data adjacency data can be viewed as a large set of very small samples rather than a sample bitmap gif gifv lists of all the possible pairs of adjacent tiles in practical tilesets can be quite long so i implemented a symmetry system for tiles to shorten the enumeration in this system each tile should be assigned with its symmetry type note that the tiles have the same symmetry type as their assigned letters or in other words actions of the dihedral group d4 are isomorphic for tiles and their corresponding letters with this system its enough to enumerate pairs of adjacent tiles only up to symmetry which makes lists of adjacencies for tilesets with many symmetrical tiles even the summer tileset despite drawings not being symmetrical the system considers such tiles to be symmetrical several times shorter note that the unrestrained knot tileset with all 5 tiles being allowed is not interesting for wfc because you cant run into a situation where you cant place a tile we call tilesets with this property easy for example wang tilesets are easy without special heuristics easy tilesets dont produce interesting global arrangements because correlations of tiles in easy tilesets quickly fall off with a distance many interesting wang tilesets can be found on cr31s site consider the dual 2 edge tileset there how can it generate knots without t junctions not easy while being easy the answer is it can only generate a narrow class of knots it cant produce an arbitrary knot higher dimensions wfc algorithm in higher dimensions works completely the same way as in dimension 2 though performance becomes an issue these voxel models were generated with n 2 overlapping tiled model using 5x5x5 and 5x5x2 blocks and additional heuristics height density curvature higher resolution screenshots 1 2 3 voxel models generated with wfc and other algorithms will be in a separate repo constrained synthesis wfc algorithm supports constraints therefore it can be easely combined with other generative algorithms or with manual creation here is wfc autocompleting a level started by a human gif gifv convchain algorithm satisfies the strong version of the condition c2 the limit distribution of nxn patterns in the outputs it is producing is exactly the same as the distributions of patterns in the input however convchain doesnt satisfy c1 it often produces noticeable artefacts it makes sense to run convchain first to get a well sampled configuration and then run wfc to correct local artefacts this is similar to a common strategy in optimization first run a monte carlo method to find a point close to a global optimum and then run a gradient descent from that point for greater accuracy p f harrisons texture synthesis algorithm is significantly faster than wfc but it has trouble with long correlations for example its difficult for this algorithm to synthesize brick wall textures with correctly aligned bricks but this is exactly where wfc shines and harrisons algorithm supports constraints it makes sense first to generate a perfect brick wall blueprint with wfc and then run a constrained texture synthesis algorithm on that blueprint comments why the minimal entropy heuristic i noticed that when humans draw something they often follow the minimal entropy heuristic themselves thats why the algorithm is so enjoyable to watch the overlapping model relates to the simple tiled model the same way higher order markov chains relate to order one markov chains note that the entropy of any node cant increase during the propagation phase i e possibilities are not arising but can be canceled when propagation step can not decrease entropy further we activate observation step if the observation step can not decrease entropy that means that the algorithm has finished working wfcs propagation phase is very similar to the loopy belief propagation algorithm in fact i first programmed belief propagation but then switched to constraint propagation with a saved stationary distribution because bp is significantly slower without a massive parallelization on a cpu and didnt produce significantly better results in my problems note that the simple knot and trick knot samples have 3 colors not 2 one of the dimensions can be time in particular d dimensional wfc captures the behaviour of any d 1 dimensional cellular automata references this project builds upon paul merrells work on model synthesis in particular discrete model synthesis chapter of his dissertation paul propagates adjacency constraints in what we call a simple tiled model with a heuristic that tries to complete propagation in a small moving region it was also heavily influenced by declarative texture synthesis chapter of paul f harrisons dissertation paul defines adjacency data of tiles by labeling their borders and uses backtracking search to fill the tilemap notable ports forks and spinoffs emil ernerfeldt made a c port max aller made a kotlin jvm library kollapse kevin chapelier made a javascript port oskar stalberg programmed a 3d tiled model a 2d tiled model for irregular grids on a sphere and is building beautiful 3d tilesets for them 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 joseph parker adapted wfc to unity and used it generate skateparks in the proc skater 2016 game and fantastic plateaus in the 2017 game swapland martin oleary applied a wfc like algorithm to poetry generation 1 2 3 4 nick nenov made a 3d voxel tileset based on my castle tileset nick uses text output option in the tiled model to reconstruct 3d models in cinema 4d sean leffler implemented the overlapping model in rust rid5x is making an ocaml version of wfc i published a very basic 3d tiled model so people could make their own 3d tilesets without waiting for the full 3d repository i made an interactive version of the overlapping model you can download the gui executable from the wfc itch io page brian bucklew built a level generation pipeline that applies wfc in multiple passes for the caves of qud game 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 danny wynne implemented a 3d tiled model arvi teikari programmed a texture synthesis algorithm with the entropy heuristic in lua headchant ported it to work with l√∂ve isaac karth made a python port of the overlapping model oskar stalberg made an interactive version of the tiled model that runs in the browser matt rix implemented a 3d tiled model 1 2 3 4 and made a 3 dimensional tiled model where one of the dimensions is time 1 2 3 4 nick nenov made a visual guide to the tile symmetry system isaac karth and adam m smith wrote a research paper where they formulate wfc as an asp problem use general constraint solver clingo to generate bitmaps experiment with global constraints trace wfcs history and give detailed explanation of the algorithm sylvain lefebvre made a c implementation of 3d model synthesis described the thought process of designing a sample and provided an example where adjacency constraints ensure that the output is connected walkable i generalized 3d wfc to work with cube symmetry group and made a tileset that generates escheresque scenes there are many ways to visualize partially observed wave states in the code color values of possible options are averaged to produce the resulting color oskar stalberg shows partially observed states as semi transparent boxes where the box is bigger for a state with more options in the voxel setting i visualize wave states with per voxel voting remy devaux implemented the tiled model in pico 8 and wrote an article about generation of coherent data with the explanation of wfc for the upcoming game bad north oskar stalberg uses a heuristic that tries to select such tiles that the resulting observed zone is navigable at each step william manning implemented the overlapping model in c with the primary goal of making code readable and provided it with wpf gui joseph parker wrote a wfc tutorial for procjam 2017 aman tiwari formulated the connectivity constraint as an asp problem for clingo matveyk programmed a 3d overlapping model sylvain lefebvre li yi wei and connelly barnes are investigating the possibility of hiding information inside textures they made a tool that can encode text messages as wfc tilings and decode them back this technique allows to use wfc tilings as qr codes mathieu fehr and nathanael courant significantly improved the running time of wfc by an order of magnitude for the overlapping model how to build wfc is a console application that depends only on the standard library build instructions from the community for various platforms can be found in the relevant issue casey marshall made a pull request that makes using the program with the command line more convenient and includes snap packaging credits some samples are taken from the games ultima iv and dungeon crawl circles tileset is taken from mario klingemann idea of generating integrated circuits was suggested to me by moonasaur and their style was taken from zachtronics ruckingenur ii cat overlapping sample is taken from the nyan cat video qud sample was made by brian bucklew magic office spirals samples by rid5x colored city link link 2 mazelike red dot smile city overlapping samples by arvi teikari summer tileset was made by hermann hillmann voxel models were rendered in magicavoxel