mask r cnn for object detection and segmentation this is an implementation of mask r cnn on python 3 keras and tensorflow the model generates bounding boxes and segmentation masks for each instance of an object in the image its based on feature pyramid network fpn and a resnet101 backbone the repository includes source code of mask r cnn built on fpn and resnet101 training code for ms coco pre trained weights for ms coco jupyter notebooks to visualize the detection pipeline at every step parallelmodel class for multi gpu training evaluation on ms coco metrics ap example of training on your own dataset the code is documented and designed to be easy to extend if you use it in your research please consider referencing this repository if you work on 3d vision you might find our recently released matterport3d dataset useful as well this dataset was created from 3d reconstructed spaces captured by our customers who agreed to make them publicly available for academic use you can see more examples here getting started demo ipynb is the easiest way to start it shows an example of using a model pre trained on ms coco to segment objects in your own images it includes code to run object detection and instance segmentation on arbitrary images train shapes ipynb shows how to train mask r cnn on your own dataset this notebook introduces a toy dataset shapes to demonstrate training on a new dataset model py utils py config py these files contain the main mask rcnn implementation inspect data ipynb this notebook visualizes the different pre processing steps to prepare the training data inspect model ipynb this notebook goes in depth into the steps performed to detect and segment objects it provides visualizations of every step of the pipeline inspect weights ipynb this notebooks inspects the weights of a trained model and looks for anomalies and odd patterns step by step detection to help with debugging and understanding the model there are 3 notebooks inspect data ipynb inspect model ipynb inspect weights ipynb that provide a lot of visualizations and allow running the model step by step to inspect the output at each point here are a few examples 1 anchor sorting and filtering visualizes every step of the first stage region proposal network and displays positive and negative anchors along with anchor box refinement 2 bounding box refinement this is an example of final detection boxes dotted lines and the refinement applied to them solid lines in the second stage 3 mask generation examples of generated masks these then get scaled and placed on the image in the right location 4 layer activations often its useful to inspect the activations at different layers to look for signs of trouble all zeros or random noise 5 weight histograms another useful debugging tool is to inspect the weight histograms these are included in the inspect weights ipynb notebook 6 logging to tensorboard tensorboard is another great debugging and visualization tool the model is configured to log losses and save weights at the end of every epoch 6 composing the different pieces into a final result training on ms coco were providing pre trained weights for ms coco to make it easier to start you can use those weights as a starting point to train your own variation on the network training and evaluation code is in samples coco coco py you can import this module in jupyter notebook see the provided notebooks for examples or you can run it directly from the command line as such train a new model starting from pre trained coco weights python3 samples coco coco py train dataset path to coco model coco train a new model starting from imagenet weights python3 samples coco coco py train dataset path to coco model imagenet continue training a model that you had trained earlier python3 samples coco coco py train dataset path to coco model path to weights h5 continue training the last model you trained this will find the last trained weights in the model directory python3 samples coco coco py train dataset path to coco model last you can also run the coco evaluation code with run coco evaluation on the last trained model python3 samples coco coco py evaluate dataset path to coco model last the training schedule learning rate and other parameters should be set in samples coco coco py training on your own dataset start by reading this blog post about the balloon color splash sample it covers the process starting from annotating images to training to using the results in a sample application in summary to train the model on your own dataset youll need to extend two classes config this class contains the default configuration subclass it and modify the attributes you need to change dataset this class provides a consistent way to work with any dataset it allows you to use new datasets for training without having to change the code of the model it also supports loading multiple datasets at the same time which is useful if the objects you want to detect are not all available in one dataset see examples in samples shapes train shapes ipynb samples coco coco py samples balloon balloon py and samples nucleus nucleus py differences from the official paper this implementation follows the mask rcnn paper for the most part but there are a few cases where we deviated in favor of code simplicity and generalization these are some of the differences were aware of if you encounter other differences please do let us know image resizing to support training multiple images per batch we resize all images to the same size for example 1024x1024px on ms coco we preserve the aspect ratio so if an image is not square we pad it with zeros in the paper the resizing is done such that the smallest side is 800px and the largest is trimmed at 1000px bounding boxes some datasets provide bounding boxes and some provide masks only to support training on multiple datasets we opted to ignore the bounding boxes that come with the dataset and generate them on the fly instead we pick the smallest box that encapsulates all the pixels of the mask as the bounding box this simplifies the implementation and also makes it easy to apply image augmentations that would otherwise be harder to apply to bounding boxes such as image rotation to validate this approach we compared our computed bounding boxes to those provided by the coco dataset we found that 2 of bounding boxes differed by 1px or more 0 05 differed by 5px or more and only 0 01 differed by 10px or more learning rate the paper uses a learning rate of 0 02 but we found that to be too high and often causes the weights to explode especially when using a small batch size it might be related to differences between how caffe and tensorflow compute gradients sum vs mean across batches and gpus or maybe the official model uses gradient clipping to avoid this issue we do use gradient clipping but dont set it too aggressively we found that smaller learning rates converge faster anyway so we go with that contributing contributions to this repository are welcome examples of things you can contribute speed improvements like re writing some python code in tensorflow or cython training on other datasets accuracy improvements visualizations and examples you can also join our team and help us build even more projects like this one requirements python 3 4 tensorflow 1 3 keras 2 0 8 and other common packages listed in requirements txt ms coco requirements to train or test on ms coco youll also need pycocotools installation instructions below ms coco dataset download the 5k minival and the 35k validation minus minival subsets more details in the original faster r cnn implementation if you use docker the code has been verified to work on this docker container installation install dependencies bash pip3 install r requirements txt clone this repository run setup from the repository root directory bash python3 setup py install download pre trained coco weights mask rcnn coco h5 from the releases page optional to train or test on ms coco install pycocotools from one of these repos they are forks of the original pycocotools with fixes for python3 and windows the official repo doesnt seem to be active anymore linux https github com waleedka coco windows https github com philferriere cocoapi you must have the visual c 2015 build tools on your path see the repo for additional details projects using this model if you extend this model to other datasets or build projects that use it wed love to hear from you 4k video demo by karol majek images to osm improve openstreetmap by adding baseball soccer tennis football and basketball fields splash of color a blog post explaining how to train this model from scratch and use it to implement a color splash effect segmenting nuclei in microscopy images built for the 2018 data science bowl code is in the samples nucleus directory mapping challenge convert satellite imagery to maps for use by humanitarian organisations